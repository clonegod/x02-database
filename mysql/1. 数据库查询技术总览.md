# 数据库查询技术总览

##
## 什么是查询优化技术
### Query Reuse
查询重用是指尽可能利用先前的执行结果，以达到节约查询计算全过程的时间并减少资源消耗的目的。

###### 1、查询重用技术主要集中在两个方面：

* 查询结果的重用。在缓存区中分配一块缓冲块，存放该SQL 语句文本和最后的结果集，当同样的SQL输入时，直接把结果返回。查询结果的重用技术节约了查询计划生成时间，减少了查询执行全过程的资源消耗。
* 查询计划的重用。缓存一条查询语句的执行计划及其相应语法树结构。查询计划的重用技术减少了查询计划生成的时间和资源消耗。

###### 2、查询重用技术利弊：

*	弊端，结果集很大会消耗很大的内存资源，同样的SQL不同用户应该获取的结果集可能不同
*	利端，节约了CPU和IO消耗。在实际使用的过程中，趋利避害，根据实际情况选用


### Query Rewrite
查询重写：是查询语句的一种等价转换，即对于任何相关模式的任意状态都会产生相同的结果。

###### 1、查询重写的两个目标

* 将查询转换为等价的效率更高的形式，例如将效率低的谓词转换为效率高的谓词、消除重复条件等。
* 尽量将查询重写为等价、简单且不受表顺序限制的形式，为物理查询优化阶段提供更多的选择，如视图的重写、子查询的合并转换等。

###### 2、查询重写的依据

* 关系代数的等价变换规则对查询重写提供了理论上的支持。
* 查询重写后，查询优化器可能生成多个连接路径，可以从候选者中择优。

###### 3、查询重写优化技术类型

* 语法级。查询语言层的优化，基于语法进行优化。
* 代数级。查询使用形式逻辑进行优化，运用关系代数的原理进行优化。
* 语义级。根据完整性约束，对查询语句进行语义理解，推知一些可优化的操作。
* 物理级。物理优化技术，基于代价估算模型，比较得出各种执行方式中代价最小的。

###### 4、查询重写优化思路

* 将过程性查询转换为描述性的查询，如视图重写。
* 将复杂的查询（如嵌套子查询、外连接消除、嵌套连接消除）尽可能转换为多表连接查询。
* 将效率低的谓词转换为等价的效率高的谓词（如等价谓词重写）。
* 利用等式和不等式的性质，简化WHERE、HAVING和ON条件。 a=b & b=1 重写为 a=1 & b=1

查询重写技术类型，每一类都有自己的规则，这些规则没有确定的、统一的规律，但重写的核心一定是“等价转换”，只有等价才能转换，这是需要特别强调的。


### Query Optimization Algorithm
###### 1、什么是查询优化算法？

查询优化，求解给定查询语句的高效执行计划的过程。这样的过程，包括了多种子问题求解。不同的子问题，对应了不同的解决方法，即算法。

###### 2、什么是查询计划？

查询计划，也称为**查询树**，它由一系列内部的操作符组成，这些操作符按一定的运算关系构成查询的一个执行方案。

简单说，就是表A和表B先连接得到中间结果，然后再和另外的表C连接得到新的中间方式，直至所有表都被连接完毕。（A连接B连接C、C连接B连接A就是两种不同的执行方案，即是两个不同的执行计划，查询优化要选出最高效的一个执行方案）。


###### 3、查询计划，二叉树上的不同结点：

a. 单表结点。
考虑单表的数据获取3种不同方式:

* 全表扫描：直接通过IO获得数据
* 索引只读扫描：通过索引获取到据，索引就能直接提供需要的数据
* 索引扫描：是通过索引定位数据的位置后再经过IO到数据块中获取数据

这是一个从物理存储到内存解析成逻辑字段的过程，即符合冯·诺依曼体系结构的的要求（外存数据读入内存才能被处理）。

b. 两表连接结点。
考虑两表以何种方式连接、代价有多大、连接路径有哪些等。

不同的连接算法导致的连接效率不同，如：

* 数据少时可使用Hash连接
* 数据量大可使用嵌套连接
* 数据如果有序可使用归并连接或先排序后使用归并连接等。

c. 多表连接结点。
考虑多表连接顺序如何构成代价最少的“执行计划”。

决定是AB先连接还是BC先连接，这是一个比较花费大小的运算。如果太多的连接方式被判断，也会导致效率问题。

多个关系采用不同次序进行连接，花费的CPU资源、内存资源差异可能较大。

许多数据库采用左深树、右深树、紧密树三种方式或其中一部分对多表进行连接得到多种连接路径。


###### 4、生成最优查询计划的策略

* 基于规则优化，具有操作简单且能快速确定连接方式的优点，但这种方法只是排除了一部分不好的可能，所以得到的结果未必是最好的；

* 基于代价优化，是对各种可能的情况进行量化比较，从而可以得到花费最小的情况，但如果组合情况比较多则花费的判断时间就会很多；

查询优化器的实现，基本上都是两种优化策略组合使用，如MySQL和PostgreSQL就采取了基于规则和代价估算的查询优化策略。



### Parallel Query Optimization

###### 1、传统单机数据库
传统单机数据库系统中，给定一个查询（Query），查询优化算法只需找到查询的一个具有最小执行花费的执行计划，这样的计划必定具有最快的响应时间。

###### 2、并行数据库
在并行数据库系统中，查询优化的目标是寻找具有最小响应时间的查询执行计划，这需要把查询工作分解为一些可以并行运行的子工作。一些商业数据库提供了并行查询的功能，用以优化查询执行操作。


###### 3、查询优化并行的条件

一个查询能否并行执行，取决于多种因素：

* 系统中的可用资源（如内存、高速缓存中的数据量等）。
* CPU的数目。
* 运算中的特定代数运算符。

如A、B、C、D四个表进行连接，每个表的单表扫描可以并行进行；在生成四个表连接的查询计划过程中，可选择A和B连接的同时C和D进行连接，这样连接操作能并行运行。不同商业数据库，对查询并行的实现也不尽相同。

在同一个SQL内，查询并行可以分为：

* 操作内并行。将同一操作如单表扫描操作、两表连接操作、排序操作等分解成多个独立的子操作，由不同的CPU同时执行。
* 操作间并行。一条SQL查询语句可以分解成多个子操作，由多个CPU执行。



## 什么是逻辑查询优化(重点)
关系理论 + 查询重写 + 启发式规则 = 逻辑查询优化

###### 1、查询的基本操作
*1.1、选择操作*

通过where条件过滤不满足条件的行。减少IO和CPU的消耗、节约内存空间。

选择操作是使元组的个数“尽量少”。

*1.2、投影操作*

只查询需要的列，节约内存空间。

投影操作是使一条元组“尽量小”。这样虽然不能减少IO（数据库存储方式是按行存储，元组是读取的最基本单位，所以要想操作列则必须读取一行数据），但可以各减少连接后的中间关系的元组大小，节约内存空间。


*1.3、连接操作*

连接操作涉及两个子问题：

	> 表连接顺序，多表连接中每个表被连接的顺序决定着效率。
如果一个查询语句只有一个表，则这样的语句很简单；但如果有多个表，则会涉及表之间以什么样的顺序连接最高效（如A、B、C三表连接，如果ABC、ACB、BCA等连接后的结果集一样，则哪种连接次序的效率最高，是需要考虑的问题）。

	> 表连接的语义，多表连接每个表被连接的顺序被用户语义决定。
查询语句多表连接有着不同的语义（如是笛卡儿集、内连接、还是外连接中的左外连接等），这决定着表之间的前后连接次序是不能随意更换的，否则，结果集中数据是不同的。因此，表的前后连接次序是不能随意交换的。

*1.4、查询的两种类型*

根据SQL语句的形式特点，还可以做如下区分：

	> 针对SPJ的查询优化。 S-Select, P-Projection, J-Join
	基于选择、投影、连接三种基本操作相结合的查询。

	> 针对非SPJ的查询优化。
	在SPJ的基础上存在GROUPBY操作的查询，这是一种较为复杂的查询。
所以，针对SPJ和非SPJ的查询优化，其实是对以上多种操作的优化。

“选择”和“投影”操作，可以在关系代数规则的指导下进行优化。

表连接，需要多表连接的相关算法完成优化。

其他操作的优化多是基于索引和代价估算完成的。

###### 2、查询重写规则
* 子查询优化
* 视图重写
* 等价谓词转换
* 条件简化
* 外连接消除
* 嵌套连接消除
* 连接消除
* 语义优化
* 针对非 SPJ 的优化

## 什么是物理查询优化(重点)

代价模型 + 索引/索引的利用 + 单表扫描算法 + 两表连接算法 + 多表连接算法 = 物理查询优化


## MySQL的查询执行计划 Explain 工具

###### 语法格式：
EXPLAIN [explain_type] explainable_stmt

###### 可选项包括：
EXTENDED | PARTITIONS | FORMAT = format_name

format_name:
    TRADITIONAL | JSON

###### 说明：
1、 EXPLAIN命令，显示SQL语句的查询执行计划。

2、 EXPLAIN EXTENDED命令，显示SQL语句的详细的查询执行计划；之后可以通过“SHOW WARNINGS”命令查看详细的信息。

3、 EXPLAIN PARTITIONS命令，显示SQL语句的带有分区表信息的查询执行计划。

4、 EXPLAIN命令的输出格式有两种。

	4.1  TRADITIONAL；传统类型；按行隔离，每行标识一个子操作。
	4.2  JSON；JSON格式。

5、 explainable_stmt，可被EXPLAIN执行的SQL语句，包括的类型有：SELECT、INSERT、UPDATE、DELETE。








