# 数据库查询优化技术

-------------------------------------------------------
### NoSQL 数据库
典型的NoSQL数据库代表：Redis, MongoDB, HBase

NoSQL数据库的特点：

	数据分布式存储，具有很好的水平扩展能力。
	无事务支持，或仅提供很小的事务支持。
	非结构化数据存储，一般仅提供简单的key-value存储，查询速度非常快。

NoSQL是基于CAP理论进行设计的。
##### 什么是CAP理论
CAP理论是说，一个系统不能同时满足C,A,P三个需求，最多只能同时满足其中的两个。

对于大多数NoSQL设计，都倾向于放弃一致性，侧重于分区容错性和可用性，通过削减关系型和事务相关的功能来满足CAP理论。

##### C: 一致性。
在分布式环境中，各个节点的数据是一致的，从任何一个节点读取到的数据都是相同的。

##### A：可用性。
在分布式环境中，集群环境是随时可用的，每一个操作总是能在确定的时间内返回。 

##### P：分区容错性（不可预测的，是无法避免的）。
在分布式环境中，在出现网络分区（如断网等网络异常）时，集群内部节点间通信不可达，处于分离状态的系统仍然能提供服务。 

-------------------------------------------------------

## 数据库管理系统 DBMS / Database Management System
## MySQL 关系型数据库

#### 衡量数据库的标准

ACID - 是指在数据库管理系统中，事务所具有的4个特性：

	原子性 Atomicity
	一致性 Consistency
	隔离性 Isolation
	持久性 Durability

#### 数据库调优 Database Tuning
##### 数据库调优
被调优的对象是整个数据库管理系统，是从数据库全局进行开展的。

目标：使数据库运行得更快，具有更高的吞吐量/TPS(每秒完成的事务数)，更短的响应时间。

##### 查询语句调优
被调优的对象是一条查询语句。

目标：让查询更快的得到结果。

### 查询优化技术（广义范围）
###### Query reuse -> 查询重用
	The query resutl reuse 重用查询结果
	*The query plan reuse   重用查询执行计划（MySQL5.6.10 Not Support）

###### The Rule of Query Rewrite -> 查询重写规则
	View Rewrite 视图重写
	Sub-query Optimaztion 子查询优化
	Equivalent Predicate Rewrite 等价谓词重写
	Condition Simplification 条件化简
	Outer Join Elimination 外连接的消除
	*Join Elimination 连接的消除（MySQL5.6.10 Not Support）
	Nest Join Elimination 嵌套连接的消除
	Sematic Optimization 语义优化（比如基于字段notNull属性进行优化）
	
###### The Algorithm of Query Optimization -> 查询优化算法
基于代价估算模型，对查询中的每一个操作进行代价估算，求解出最小代价

	Single Table Scan Algorithm 单表扫描算法：全部扫描，索引扫描，基于行id的直接定位
	Two Table Join Algorithm  两表连接算法：嵌套循环连接算法，归并连接算法，哈希连接算法
	Multi-table Join Algorithm  多表连接算法：贪婪算法、穷举算法

###### Parallel Query Optimization -> 并行查询优化（MySQL5.6.10 Not Support）
将一个sql查询分解为几个小的部分，并行执行每个小的查询

###### Distribute Query Optimization -> 分布式查询优化（MySQL5.6.10 Not Support）
	数据分布，指的是数据被分布式存储到集群中不同的节点上；
	处理单元分布，指的是每个服务节点的资源（CPU,内存）是独立的；

让分布式存储的数据，由相对应的处理单元高效的操作，尽快得到查询结果。


### 数据库调优的几个阶段
##### 需求分析阶段：应用情况的估算，系统选型
* 应用特点：读多写少还是读写均衡？

* 并发数：应用对数据库并发的要求，连接池的设置

* 选型：单机/集群？ 开源/商业？网络要求-1000M网卡，硬件要求-ssd？

##### 项目设计阶段：数据模型设计
* E-R模型设计：遵循ER模型设计原则，偶尔适当的非规范化可以改善系统查询性能。

* 数据逻辑分布策略：如互联网企业典型的用法，根据业务的不同，进行分库，分表等操作。

* 数据物理分布策略：目的是减少IO次数，如启用压缩技术，把索引和表数据的存储分开，日志、索引、数据分布在不同的物理存储上。

* 索引：
在查询频繁的对象上建立合适的索引，使索引的正效应大于负效应（索引维护存在性能消耗）。只建立必须的索引，索引不是越多越好。

##### 开发阶段：SQL设计
* 编写正确、查询效率高的SQL语句。这依据的主要是“查询重写规则”，编写语句的过程中要注意，要有意识的**保障SQL能利用到索引**。

##### 测试与运行阶段：数据库功能的启用
* 查询重用：根据使用情况进行配置，可缓存查询执行计划，缓存查询执行结果等。仅针对可重复查询的场景下有用，否则将浪费系统内存。一般都不建议查询缓存。
* 数据库参数设置：如数据缓冲区等。
* 备用系统上模拟实际运行环境，进行压力测试，提前发现问题。

##### 上线与维护阶段：系统监控与分析
* 应用系统的表现：收集用户对应用系统的使用意见，系统存在的问题，这些是用户第一时间发现的。
* OS环境监控：实时监测CPU，内存，IO等，并对比实时情况与历史正常情况。
* 数据库内部状态监控：实时监控数据库运行过程中内部的状态信息，如锁的情况。
* 日志分析：在数据库日志、操作系统日志中找出异常事件，定位问题。


